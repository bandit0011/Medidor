<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datos ThingSpeak - Actualización Automática</title>
    <!-- Incluimos la librería de Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 20px;
        }
        h1 {
            text-align: center;
        }
        .chart-container {
            width: 80%;
            margin: 0 auto;
        }
        .chart {
            margin: 20px 0;
        }
    </style>
</head>
<body>

    <h1>Visualización de Datos con ThingSpeak</h1>
    
    <!-- Contenedores para los gráficos -->
    <div class="chart-container">
        <canvas id="chartCorriente" class="chart"></canvas>
    </div>
    
    <div class="chart-container">
        <canvas id="chartVoltaje" class="chart"></canvas>
    </div>

    <script>
        // API Key de lectura y la URL de ThingSpeak
        const apiKey = '0UU08QNI5IPVG4AB'; // API Key de lectura
        const channelId = '2701710';        // ID de canal
        const updateInterval = 15000;       // Intervalo de actualización en milisegundos (15000 = 15 segundos)

        // Variables para los gráficos
        let chartCorriente;
        let chartVoltaje;

        // Función para obtener los datos de ThingSpeak
        async function getThingSpeakData() {
            const url = `https://api.thingspeak.com/channels/${channelId}/feeds.json?api_key=${apiKey}&results=10`;
            const response = await fetch(url);
            const data = await response.json();
            return data.feeds;  // Devolvemos los feeds con los datos
        }

        // Función para inicializar ambos gráficos (Corriente y Voltaje)
        async function createCharts() {
            const feeds = await getThingSpeakData();
            
            // Extraemos los datos de tiempo y valores (Field 1 para Corriente, Field 2 para Voltaje)
            const labels = feeds.map(feed => new Date(feed.created_at).toLocaleString());
            const dataCorriente = feeds.map(feed => parseFloat(feed.field1));  // Field 1: Corriente
            const dataVoltaje = feeds.map(feed => parseFloat(feed.field2));    // Field 2: Voltaje

            // Configuración del gráfico de Corriente (Field 1)
            const ctxCorriente = document.getElementById('chartCorriente').getContext('2d');
            chartCorriente = new Chart(ctxCorriente, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Corriente (Field 1)',
                        data: dataCorriente,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Tiempo'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Corriente (A)' // Unidades de corriente
                            }
                        }
                    }
                }
            });

            // Configuración del gráfico de Voltaje (Field 2)
            const ctxVoltaje = document.getElementById('chartVoltaje').getContext('2d');
            chartVoltaje = new Chart(ctxVoltaje, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Voltaje (Field 2)',
                        data: dataVoltaje,
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Tiempo'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Voltaje (V)' // Unidades de voltaje
                            }
                        }
                    }
                }
            });
        }

        // Función para actualizar los gráficos
        async function updateCharts() {
            const feeds = await getThingSpeakData();
            
            // Extraemos los datos de tiempo y valores (Field 1 para Corriente, Field 2 para Voltaje)
            const labels = feeds.map(feed => new Date(feed.created_at).toLocaleString());
            const dataCorriente = feeds.map(feed => parseFloat(feed.field1));  // Field 1: Corriente
            const dataVoltaje = feeds.map(feed => parseFloat(feed.field2));    // Field 2: Voltaje

            // Actualizamos los datos de Corriente
            chartCorriente.data.labels = labels;
            chartCorriente.data.datasets[0].data = dataCorriente;
            chartCorriente.update();

            // Actualizamos los datos de Voltaje
            chartVoltaje.data.labels = labels;
            chartVoltaje.data.datasets[0].data = dataVoltaje;
            chartVoltaje.update();
        }

        // Inicializamos los gráficos al cargar la página
        createCharts();

        // Actualizamos los gráficos cada 15 segundos
        setInterval(updateCharts, updateInterval);

    </script>

</body>
</html>
